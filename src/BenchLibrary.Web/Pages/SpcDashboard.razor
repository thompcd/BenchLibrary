@page "/spc-dashboard"
@inject SpcDataService SpcService

<PageTitle>SPC Dashboard - Control Charts</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Statistical Process Control Dashboard</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" GutterBottom="true">X-bar Chart (Subgroup Means)</MudText>
            @if (_xbarChart != null)
            {
                <MudSimpleTable Dense="true" Striped="true">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Center Line (X-bar-bar)</td>
                            <td>@_xbarChart.CenterLine.ToString("F4")</td>
                        </tr>
                        <tr>
                            <td>Upper Control Limit (UCL)</td>
                            <td>@_xbarChart.UpperControlLimit.ToString("F4")</td>
                        </tr>
                        <tr>
                            <td>Lower Control Limit (LCL)</td>
                            <td>@_xbarChart.LowerControlLimit.ToString("F4")</td>
                        </tr>
                        <tr>
                            <td>Points Out of Control</td>
                            <td>
                                <MudChip T="string" Color="@(_xbarChart.OutOfControlCount > 0 ? Color.Error : Color.Success)" Size="Size.Small">
                                    @_xbarChart.OutOfControlCount
                                </MudChip>
                            </td>
                        </tr>
                        <tr>
                            <td>Estimated Sigma</td>
                            <td>@_xbarChart.EstimatedSigma.ToString("F4")</td>
                        </tr>
                    </tbody>
                </MudSimpleTable>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.subtitle2">Data Points</MudText>
                <div style="max-height: 200px; overflow-y: auto;">
                    <MudSimpleTable Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Value</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var point in _xbarChart.Points)
                            {
                                <tr>
                                    <td>@point.SampleNumber</td>
                                    <td>@point.Value.ToString("F4")</td>
                                    <td>
                                        @if (point.IsOutOfControl)
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Small" />
                                        }
                                        else
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                </div>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" GutterBottom="true">R Chart (Subgroup Ranges)</MudText>
            @if (_rChart != null)
            {
                <MudSimpleTable Dense="true" Striped="true">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Center Line (R-bar)</td>
                            <td>@_rChart.CenterLine.ToString("F4")</td>
                        </tr>
                        <tr>
                            <td>Upper Control Limit (UCL)</td>
                            <td>@_rChart.UpperControlLimit.ToString("F4")</td>
                        </tr>
                        <tr>
                            <td>Lower Control Limit (LCL)</td>
                            <td>@_rChart.LowerControlLimit.ToString("F4")</td>
                        </tr>
                        <tr>
                            <td>Points Out of Control</td>
                            <td>
                                <MudChip T="string" Color="@(_rChart.OutOfControlCount > 0 ? Color.Error : Color.Success)" Size="Size.Small">
                                    @_rChart.OutOfControlCount
                                </MudChip>
                            </td>
                        </tr>
                    </tbody>
                </MudSimpleTable>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.subtitle2">Data Points</MudText>
                <div style="max-height: 200px; overflow-y: auto;">
                    <MudSimpleTable Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Range</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var point in _rChart.Points)
                            {
                                <tr>
                                    <td>@point.SampleNumber</td>
                                    <td>@point.Value.ToString("F4")</td>
                                    <td>
                                        @if (point.IsOutOfControl)
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Small" />
                                        }
                                        else
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                </div>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

<MudPaper Class="mt-4 pa-4" Elevation="2">
    <MudText Typo="Typo.h6" GutterBottom="true">Simulation Controls</MudText>
    <MudGrid>
        <MudItem xs="12" md="4">
            <MudSwitch @bind-Value="_simulateShift" Color="Color.Primary" Label="Simulate Process Shift" />
        </MudItem>
        <MudItem xs="12" md="4">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="RefreshData">
                <MudIcon Icon="@Icons.Material.Filled.Refresh" Class="mr-2" /> Refresh Data
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    private ControlChartResult? _xbarChart;
    private ControlChartResult? _rChart;
    private bool _simulateShift = false;

    protected override void OnInitialized()
    {
        RefreshData();
    }

    private void RefreshData()
    {
        if (_simulateShift)
        {
            var charts = SpcService.GetControlChartsWithShift();
            _xbarChart = charts.XBar;
            _rChart = charts.R;
        }
        else
        {
            var charts = SpcService.GetControlCharts();
            _xbarChart = charts.XBar;
            _rChart = charts.R;
        }
    }
}
